<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0A1628">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Showroom Manager">
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<title>Car Showroom Manager - Central</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto',sans-serif;background:linear-gradient(135deg,#0A1628 0%,#1E3A5F 50%,#2C5F8D 100%);min-height:100vh;padding:20px;position:relative;overflow-x:hidden}
body.urdu{font-family:'Noto Nastaliq Urdu',serif;direction:rtl;text-align:right}
body.urdu .tab-buttons{flex-direction:row-reverse}
body.urdu input,body.urdu select{text-align:right;direction:rtl}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background-image:radial-gradient(circle at 20% 50%,rgba(0,212,255,.1) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(107,70,193,.1) 0%,transparent 50%);pointer-events:none;z-index:0}
.container{max-width:600px;margin:0 auto;position:relative;z-index:1}
.login-container{background:rgba(255,255,255,.95);backdrop-filter:blur(20px);padding:40px;border-radius:24px;box-shadow:0 20px 60px rgba(0,0,0,.3);text-align:center;border:1px solid rgba(255,255,255,.2)}
.login-container h1{background:linear-gradient(135deg,#0A1628 0%,#00D4FF 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-size:28px;font-weight:800;margin-bottom:10px}
.login-container p{color:#555;margin-bottom:10px;font-weight:500}
.header{background:rgba(255,255,255,.98);backdrop-filter:blur(20px);padding:24px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,.15);margin-bottom:20px;text-align:center;position:relative;border:1px solid rgba(255,255,255,.2)}
.header h1{background:linear-gradient(135deg,#0A1628 0%,#00D4FF 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-size:26px;font-weight:800;margin-bottom:8px}
.header p{color:#666;font-size:14px;font-weight:500}
.logout-btn{background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);color:white;border:none;padding:10px 20px;border-radius:12px;font-size:13px;font-weight:600;cursor:pointer;margin-top:12px;margin-left:8px;transition:all .3s ease;box-shadow:0 4px 15px rgba(220,53,69,.3)}
.logout-btn:hover{transform:translateY(-2px)}
.manage-btn{background:linear-gradient(135deg,#00D4FF 0%,#6B46C1 100%);box-shadow:0 4px 15px rgba(0,212,255,.3)}
.lang-btn{background:linear-gradient(135deg,#D4AF37 0%,#FFD700 100%);color:#333 !important;font-weight:700 !important;box-shadow:0 4px 15px rgba(212,175,55,.3)}
.verify-btn{background:linear-gradient(135deg,#17a2b8 0%,#138496 100%);box-shadow:0 4px 15px rgba(23,162,184,.3);margin-left:8px}
.notification-badge{position:absolute;top:15px;right:15px;background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);color:white;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;animation:pulse 2s infinite;box-shadow:0 4px 15px rgba(220,53,69,.4)}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.install-prompt{background:linear-gradient(135deg,#00D4FF 0%,#6B46C1 100%);color:white;padding:16px;border-radius:16px;margin-bottom:20px;display:none;align-items:center;gap:12px}
.install-prompt button{background:white;color:#6B46C1;border:none;padding:10px 20px;border-radius:10px;font-weight:700;cursor:pointer;margin-left:auto}
.alert-box{background:rgba(255,243,205,.95);border-left:4px solid #D4AF37;padding:16px;border-radius:12px;margin-bottom:16px;display:none}
.alert-box.danger{background:rgba(248,215,218,.95);border-left-color:#dc3545}
.alert-box.info{background:rgba(209,236,241,.95);border-left-color:#17a2b8}
.alert-box strong{font-size:18px}
.alert-box div{font-size:16px;line-height:1.6}
.card{background:rgba(255,255,255,.98);backdrop-filter:blur(20px);padding:24px;padding-bottom:90px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.15);margin-bottom:20px;min-height:calc(100vh - 200px);border:1px solid rgba(255,255,255,.2)}
.tab-buttons{display:flex;gap:6px;background:rgba(255,255,255,.98);backdrop-filter:blur(20px);position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:12px;box-shadow:0 10px 40px rgba(0,0,0,.2);z-index:100;max-width:560px;width:calc(100% - 40px);border-radius:20px;border:1px solid rgba(255,255,255,.2)}
.tab-btn{flex:1;padding:10px 4px;border:none;background:transparent;color:#666;border-radius:14px;font-size:10px;font-weight:700;cursor:pointer;transition:all .4s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;align-items:center;gap:4px;position:relative}
.tab-btn .tab-icon{font-size:20px}
.tab-btn.active{background:linear-gradient(135deg,#00D4FF 0%,#6B46C1 100%);color:white;transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,212,255,.4)}
.tab-btn .badge{position:absolute;top:6px;right:8px;background:#dc3545;color:white;font-size:9px;padding:2px 5px;border-radius:10px;font-weight:700}
.tab-content{display:none}
.tab-content.active{display:block}
.form-group{margin-bottom:18px}
label{display:block;margin-bottom:8px;color:#2C3E50;font-weight:700;font-size:14px}
input[type=text],input[type=password],input[type=email],input[type=date],input[type=number],select{width:100%;padding:14px 16px;border:2px solid #E8ECF0;border-radius:12px;font-size:16px;transition:all .3s ease;background:#F8F9FA;color:#2C3E50;font-weight:500}
input:focus,select:focus{outline:none;border-color:#00D4FF;background:white;box-shadow:0 0 0 4px rgba(0,212,255,.1)}
input[type=file]{width:100%;padding:14px;border:2px dashed #00D4FF;border-radius:12px;cursor:pointer;font-size:14px;background:rgba(0,212,255,.05)}
.radio-group{display:flex;gap:20px;margin:10px 0;flex-wrap:wrap}
.radio-group label{display:flex;align-items:center;font-weight:normal;cursor:pointer}
input[type=radio]{margin-right:8px}
.installment-section{background:rgba(0,212,255,.05);padding:16px;border-radius:12px;margin-top:16px;display:none;border:2px solid rgba(0,212,255,.2)}
.installment-item{background:white;padding:14px;border-radius:10px;margin-bottom:12px;border-left:4px solid #00D4FF;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.btn{width:100%;padding:16px;border:none;border-radius:14px;font-size:16px;font-weight:700;cursor:pointer;transition:all .4s cubic-bezier(.4,0,.2,1);margin-top:12px}
.btn-primary{background:linear-gradient(135deg,#00D4FF 0%,#6B46C1 100%);color:white;box-shadow:0 8px 25px rgba(0,212,255,.3)}
.btn-primary:hover{transform:translateY(-3px)}
.btn-primary:disabled{opacity:.6;cursor:not-allowed;transform:none}
.btn-success{background:linear-gradient(135deg,#28a745 0%,#20c997 100%);color:white}
.btn-small{padding:10px 16px;font-size:13px;width:auto}
.preview-image{width:100%;max-height:300px;object-fit:contain;border-radius:12px;margin-top:12px;border:2px solid #E8ECF0}
.receipt-item{padding:18px;border:2px solid #E8ECF0;border-radius:16px;margin-bottom:12px;cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1);background:linear-gradient(135deg,#fff 0%,#f8f9fa 100%)}
.receipt-item:hover{border-color:#00D4FF;transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,212,255,.15)}
.receipt-item.pending-payment{border-left:5px solid #D4AF37;background:linear-gradient(135deg,#FFFBF0 0%,#FFF8E1 100%)}
.receipt-item.overdue-payment{border-left:5px solid #dc3545;background:linear-gradient(135deg,#FFF5F7 0%,#FFE8EB 100%)}
.receipt-reg{font-size:19px;font-weight:800;background:linear-gradient(135deg,#0A1628 0%,#00D4FF 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px}
.receipt-date{font-size:13px;color:#7C8B9A;font-weight:500;margin-bottom:4px}
.payment-badge{display:inline-block;padding:6px 12px;border-radius:8px;font-size:12px;font-weight:700;margin-top:8px}
.payment-badge.cash{background:linear-gradient(135deg,#d4edda 0%,#c3e6cb 100%);color:#155724}
.payment-badge.installment{background:linear-gradient(135deg,#fff3cd 0%,#ffeaa7 100%);color:#856404}
.payment-badge.pending{background:linear-gradient(135deg,#f8d7da 0%,#f5c6cb 100%);color:#721c24}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(10,22,40,.98);backdrop-filter:blur(20px);z-index:1000;padding:20px;overflow-y:auto}
.modal.active{display:flex;align-items:center;justify-content:center}
.modal-content{position:relative;max-width:900px;width:100%}
.modal-image{width:100%;max-height:85vh;object-fit:contain;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.close-modal{position:absolute;top:-50px;right:0;background:linear-gradient(135deg,#fff 0%,#f8f9fa 100%);border:none;padding:12px 24px;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(0,0,0,.3);color:#333}
body.urdu .close-modal{right:auto;left:0}
.success-msg,.error-msg{padding:14px 18px;border-radius:12px;margin-bottom:16px;display:none;font-weight:600}
.success-msg{background:linear-gradient(135deg,#d4edda 0%,#c3e6cb 100%);color:#155724;border-left:4px solid #28a745}
.error-msg{background:linear-gradient(135deg,#f8d7da 0%,#f5c6cb 100%);color:#721c24;border-left:4px solid #dc3545}
.loading{text-align:center;padding:30px;color:#00D4FF;font-weight:700;font-size:16px}
.no-results{text-align:center;padding:50px;color:#B0BEC5;font-weight:600}
.stats{display:flex;justify-content:space-around;padding:20px;background:linear-gradient(135deg,rgba(0,212,255,.1) 0%,rgba(107,70,193,.1) 100%);border-radius:16px;margin-bottom:20px;border:1px solid rgba(0,212,255,.2)}
.stat-item{text-align:center}
.stat-number{font-size:26px;font-weight:800;background:linear-gradient(135deg,#00D4FF 0%,#6B46C1 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;word-break:break-all;line-height:1.2}
@media(max-width:480px){.stat-number{font-size:18px}}
.stat-label{font-size:12px;color:#7C8B9A;margin-top:6px;font-weight:600}
.delete-btn{background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);color:white;border:none;padding:10px 18px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(220,53,69,.3)}
.hidden{display:none !important}
.verify-result{background:rgba(23,162,184,.1);border-left:4px solid #17a2b8;padding:12px;border-radius:10px;margin-top:10px;display:none}
.usage-box{background:linear-gradient(135deg,rgba(0,212,255,.15) 0%,rgba(107,70,193,.15) 100%);padding:20px;border-radius:15px;margin-bottom:20px;border:2px solid rgba(0,212,255,.3)}
.usage-box h4{color:#00D4FF;margin-bottom:15px;font-weight:700}
.usage-progress{background:rgba(255,255,255,.5);height:20px;border-radius:10px;overflow:hidden;margin:10px 0}
.usage-progress-bar{background:linear-gradient(135deg,#00D4FF 0%,#6B46C1 100%);height:100%;transition:width .3s ease}
@media(max-width:480px){body{padding:12px}.header h1{font-size:20px}.card{padding:16px;padding-bottom:90px}.tab-btn{font-size:9px;padding:8px 3px}.tab-btn .tab-icon{font-size:18px}}
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-track{background:rgba(255,255,255,.1)}
::-webkit-scrollbar-thumb{background:linear-gradient(135deg,#00D4FF 0%,#6B46C1 100%);border-radius:10px}
</style>
</head>
<body>

<!-- LICENSE ACTIVATION SCREEN -->
<div id="license-screen" class="container">
  <div class="login-container">

    <!-- Logo & Title -->
    <div style="margin-bottom:8px;font-size:48px;">üöó</div>
    <h1 style="font-size:24px;font-weight:900;background:linear-gradient(135deg,#0A1628 0%,#00D4FF 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:6px;">CAR SHOWROOM MANAGER</h1>
    <p style="color:#666;font-size:13px;font-weight:600;margin-bottom:4px;">Premium Cloud System</p>
    <div style="display:inline-block;background:linear-gradient(135deg,#00D4FF,#6B46C1);color:white;padding:3px 14px;border-radius:20px;font-size:11px;font-weight:700;margin-bottom:20px;">CENTRALIZED EDITION</div>

    <!-- Divider -->
    <div style="height:1px;background:linear-gradient(90deg,transparent,#E0E0E0,transparent);margin-bottom:24px;"></div>

    <div class="error-msg" id="license-error"></div>

    <!-- License Key Input -->
    <div class="form-group" style="text-align:left;">
      <label style="font-size:13px;color:#333;font-weight:700;">üîë License Key</label>
      <input type="text" id="license-key" placeholder="XXXX-2025-XXXX" style="text-transform:uppercase;letter-spacing:2px;font-weight:700;font-size:16px;">
    </div>

    <!-- Email Input -->
    <div class="form-group" style="text-align:left;">
      <label style="font-size:13px;color:#333;font-weight:700;">üìß Email Address</label>
      <input type="email" id="user-email" placeholder="your@email.com">
    </div>

    <!-- Activate Button -->
    <button class="btn btn-primary" onclick="activateLicense()" style="font-size:16px;font-weight:800;letter-spacing:1px;">üîì ACTIVATE</button>

    <!-- Divider -->
    <div style="display:flex;align-items:center;gap:10px;margin:20px 0;">
      <div style="flex:1;height:1px;background:#E0E0E0;"></div>
      <span style="font-size:12px;color:#999;font-weight:600;">OR</span>
      <div style="flex:1;height:1px;background:#E0E0E0;"></div>
    </div>

    <!-- New Account Section -->
    <div style="background:linear-gradient(135deg,#0A1628 0%,#1E3A5F 100%);border-radius:16px;padding:20px;text-align:center;">
      <p style="color:#00D4FF;font-size:13px;font-weight:800;margin-bottom:4px;letter-spacing:1px;">NEW ACCOUNT?</p>
      <p style="color:rgba(255,255,255,0.7);font-size:12px;margin-bottom:14px;line-height:1.5;">Get your own Car Showroom Manager system. Contact us to get started!</p>
      <a href="https://wa.me/923420202126?text=Hello!%20I%20want%20to%20get%20Car%20Showroom%20Manager%20for%20my%20showroom.%20Please%20help%20me%20get%20started!" 
         target="_blank"
         style="display:flex;align-items:center;justify-content:center;gap:10px;background:linear-gradient(135deg,#25D366 0%,#128C7E 100%);color:white;padding:14px 20px;border-radius:12px;text-decoration:none;font-weight:800;font-size:15px;box-shadow:0 6px 20px rgba(37,211,102,0.5);transition:all 0.3s ease;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="white"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
        WhatsApp: 03420202126
      </a>
      <p style="color:rgba(255,255,255,0.4);font-size:10px;margin-top:10px;">Tap to open WhatsApp directly</p>
    </div>

    <p style="margin-top:16px;font-size:10px;color:#ccc;text-align:center;">
      Powered by Car Showroom Manager &copy; 2025
    </p>

  </div>
</div>

<!-- LOGIN SCREEN -->
<div id="login-screen" class="container hidden">
  <div class="login-container">
    <h1>üöó CAR SHOWROOM MANAGER</h1>
    <p>Enter Your Password</p>
    <div style="margin-top:30px;">
      <div class="error-msg" id="login-error"></div>
      <div class="form-group" style="text-align:left;">
        <label>Password</label>
        <input type="password" id="login-password" placeholder="Enter password">
      </div>
      <button class="btn btn-primary" onclick="login()">üîì Login</button>
      <button class="btn" onclick="resetLicense()" style="background:#6c757d;color:white;margin-top:10px;">üîÑ Change License</button>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="main-app" class="container hidden">
  <div class="header">
    <h1>üöó CAR SHOWROOM MANAGER</h1>
    <p id="customer-info">Loading...</p>
    <p style="font-size:11px;color:#999;margin-top:8px;">Centralized Cloud System</p>
    <div class="notification-badge hidden" id="overdue-badge" onclick="switchTabDirect('payments')">
      <span id="overdue-count">0</span> Overdue
    </div>
    <button class="logout-btn lang-btn" onclick="toggleLanguage()">üåê <span id="lang-text">ÿßÿ±ÿØŸà</span></button>
    <button class="logout-btn manage-btn" onclick="manageEmployees()">üë• Employees</button>
    <button class="logout-btn manage-btn" onclick="manageUsers()">üë§ Users</button>
    <button class="logout-btn verify-btn" onclick="switchTab('verify',event)">üîç Verify</button>
    <button class="logout-btn" onclick="logout()">üö™ Logout</button>
  </div>

  <!-- USAGE ALERT -->
  <div class="alert-box info" id="usage-alert" style="display:none;">
    <strong>üìä Usage Update</strong>
    <div id="usage-alert-text"></div>
  </div>

  <div class="card">
    <!-- UPLOAD TAB -->
    <div id="upload-tab" class="tab-content active">
      <div class="usage-box" id="usage-stats">
        <h4>üìä Your Usage This Month</h4>
        <div style="color:#666;font-size:14px;margin-bottom:10px;">
          <strong id="usage-receipts">0/0</strong> receipts used
        </div>
        <div class="usage-progress">
          <div class="usage-progress-bar" id="usage-bar" style="width:0%"></div>
        </div>
        <div style="color:#666;font-size:12px;margin-top:10px;" id="usage-detail">Loading...</div>
      </div>

      <div class="success-msg" id="upload-success"></div>
      <div class="error-msg" id="upload-error"></div>
      
      <div class="form-group"><label>Car Name/Model *</label><input type="text" id="car-name" placeholder="e.g., Toyota Corolla 2020"></div>
      <div class="form-group">
        <label>Car Registration Number *</label>
        <div style="display:flex;gap:8px;">
          <input type="text" id="reg-number" placeholder="e.g., ABC-123" style="text-transform:uppercase;flex:1">
          <button class="btn btn-primary" onclick="verifyVehicleQuick()" style="width:auto;padding:10px 20px;margin:0;">üîç</button>
        </div>
        <div class="verify-result" id="quick-verify-result"></div>
      </div>
      <div class="form-group"><label>Customer Name *</label><input type="text" id="customer-name" placeholder="e.g., Ahmed Khan"></div>
      <div class="form-group"><label>Customer Phone *</label><input type="text" id="customer-phone" placeholder="e.g., 03001234567"></div>
      <div class="form-group"><label>Selling Date *</label><input type="date" id="selling-date"></div>
      <div class="form-group"><label>Selling Price (PKR) *</label><input type="number" id="selling-price" placeholder="e.g., 2500000" min="0" step="1000"></div>
      <div class="form-group">
        <label>Purchase Cost (PKR) *</label>
        <input type="number" id="purchase-cost" placeholder="e.g., 2000000" min="0" step="1000">
        <small style="color:#666;font-size:12px;display:block;margin-top:5px;">üí° How much did you pay to buy this car?</small>
      </div>
      <div class="form-group">
        <label>Additional Expenses (Optional)</label>
        <small style="color:#666;font-size:12px;display:block;margin-bottom:10px;">Repairs, maintenance, modifications, etc.</small>
        <div id="expenses-container"></div>
        <button type="button" class="btn btn-primary" onclick="addExpenseField()" style="width:auto;padding:10px 15px;margin-top:5px;">‚ûï Add Expense</button>
      </div>
      <div class="form-group">
        <label>Payment Type *</label>
        <div class="radio-group">
          <label><input type="radio" name="payment-type" value="CASH" checked onchange="toggleInstallmentSection()"> üíµ Cash (Full Payment)</label>
          <label><input type="radio" name="payment-type" value="INSTALLMENT" onchange="toggleInstallmentSection()"> üìÖ Installment</label>
        </div>
      </div>
      <div class="installment-section" id="installment-section">
        <div class="form-group"><label>Down Payment (PKR) *</label><input type="number" id="down-payment" placeholder="e.g., 500000" min="0" step="1000"></div>
        <div class="form-group">
          <label>Number of Installments *</label>
          <select id="installment-count" onchange="generateInstallmentFields()">
            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
            <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          </select>
        </div>
        <div id="installment-fields"></div>
      </div>
      <div class="form-group"><label>Sold By (Employee) *</label><select id="sold-by"><option value="">Select Employee</option></select></div>
      <div class="form-group"><label>Receipt Photo *</label><input type="file" id="receipt-photo" accept="image/*"></div>
      <img id="preview" class="preview-image" style="display:none">
      <button class="btn btn-primary" onclick="uploadReceipt()">üíæ Save Receipt</button>
    </div>

    <!-- VERIFY TAB -->
    <div id="verify-tab" class="tab-content">
      <h3 style="color:#00D4FF;margin-bottom:20px;font-weight:800;">üîç Vehicle Verification</h3>
      <p style="color:#666;margin-bottom:20px;font-size:14px;">Check vehicle details from Sindh Excise & Taxation Department</p>
      <div class="form-group">
        <label>Registration Number</label>
        <input type="text" id="verify-reg" placeholder="e.g., ABC-123" style="text-transform:uppercase">
      </div>
      <button class="btn btn-primary" onclick="verifyVehicle()">üîç Verify Vehicle</button>
      <div id="verify-results" style="margin-top:20px;"></div>
    </div>

    <!-- PAYMENTS TAB -->
    <div id="payments-tab" class="tab-content">
      <h3 style="color:#00D4FF;margin-bottom:20px;font-weight:800;">üí∞ Payment Tracking</h3>
      <div class="alert-box danger" id="overdue-alert"><strong>‚ö†Ô∏è Overdue Payments!</strong><div id="overdue-list" style="margin-top:10px;"></div></div>
      <div class="alert-box" id="upcoming-alert"><strong>üìÖ Upcoming Payments</strong><div id="upcoming-list" style="margin-top:10px;"></div></div>
      <div class="stats" style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
        <div class="stat-item"><div class="stat-number" id="total-pending">‚Ç®0</div><div class="stat-label">Total Pending</div></div>
        <div class="stat-item"><div class="stat-number" id="total-received">‚Ç®0</div><div class="stat-label">Total Received</div></div>
      </div>
      <button class="btn btn-primary" onclick="loadPayments()" style="margin-bottom:15px;">üîÑ Refresh</button>
      <div id="payments-list"></div>
    </div>

    <!-- SEARCH TAB -->
    <div id="search-tab" class="tab-content">
      <div class="form-group"><label>Search by Registration Number</label><input type="text" id="search-input" placeholder="e.g., ABC-123" style="text-transform:uppercase"></div>
      <div class="form-group"><label>Filter by Employee</label><select id="search-employee"><option value="">All Employees</option></select></div>
      <button class="btn btn-primary" onclick="performSearch()">üîç Search</button>
      <div id="search-results"></div>
    </div>

    <!-- ALL TAB -->
    <div id="all-tab" class="tab-content">
      <div class="stats"><div class="stat-item"><div class="stat-number" id="total-receipts">0</div><div class="stat-label">Total Receipts</div></div></div>
      <button class="btn btn-primary" onclick="loadAllReceipts()" style="margin-bottom:15px;">üîÑ Refresh</button>
      <div id="all-receipts"></div>
    </div>

    <!-- PROFIT TAB -->
    <div id="profit-tab" class="tab-content">
      <h3 style="color:#00D4FF;margin-bottom:20px;text-align:center;font-weight:800;">üíµ Profit &amp; Loss</h3>
      <div style="background:linear-gradient(135deg,#00D4FF 0%,#6B46C1 100%);padding:20px;border-radius:15px;color:white;margin-bottom:20px;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
          <div><div style="font-size:12px;opacity:.9">Total Revenue</div><div style="font-size:18px;font-weight:700;word-break:break-all;line-height:1.2" id="profit-revenue">‚Ç®0</div></div>
          <div><div style="font-size:12px;opacity:.9">Purchase Cost</div><div style="font-size:18px;font-weight:700;word-break:break-all;line-height:1.2" id="profit-purchase">‚Ç®0</div></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
          <div><div style="font-size:12px;opacity:.9">Total Expenses</div><div style="font-size:18px;font-weight:700;word-break:break-all;line-height:1.2" id="profit-expenses">‚Ç®0</div></div>
          <div><div style="font-size:12px;opacity:.9">Profit Margin</div><div style="font-size:18px;font-weight:700;line-height:1.2" id="profit-margin">0%</div></div>
        </div>
        <div style="border-top:2px solid rgba(255,255,255,.3);padding-top:15px;margin-top:15px;">
          <div style="font-size:14px;opacity:.9">Net Profit</div>
          <div style="font-size:26px;font-weight:700;word-break:break-all;line-height:1.2" id="profit-net">‚Ç®0</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;">
        <button class="btn btn-primary" onclick="exportSalesReport()" style="font-size:14px;">üìä Sales</button>
        <button class="btn btn-primary" onclick="exportProfitReport()" style="font-size:14px;">üíµ Profit</button>
        <button class="btn btn-primary" onclick="exportPaymentReport()" style="font-size:14px;">üí∞ Payments</button>
        <button class="btn btn-primary" onclick="exportExpenseReport()" style="font-size:14px;">üí∏ Expenses</button>
      </div>
      <button class="btn btn-primary" onclick="calculateProfit()" style="margin-bottom:15px;">üîÑ Refresh</button>
      <h4 style="color:#00D4FF;margin:20px 0 15px 0;font-weight:700;">Profit by Car</h4>
      <div id="profit-breakdown"></div>
    </div>

    <!-- ANALYTICS TAB -->
    <div id="analytics-tab" class="tab-content">
      <h3 style="color:#00D4FF;margin-bottom:20px;text-align:center;font-weight:800;">üìä Sales Analytics</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;margin-bottom:25px;">
        <div style="background:linear-gradient(135deg,#00D4FF 0%,#6B46C1 100%);padding:20px;border-radius:10px;color:white;text-align:center;">
          <div style="font-size:28px;font-weight:700" id="total-cars">0</div>
          <div style="font-size:12px;margin-top:5px">Total Cars Sold</div>
        </div>
        <div style="background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);padding:20px;border-radius:10px;color:white;text-align:center;">
          <div style="font-size:22px;font-weight:700;word-break:break-all" id="total-revenue">‚Ç®0</div>
          <div style="font-size:12px;margin-top:5px">Total Revenue</div>
        </div>
      </div>
      <div style="background:rgba(0,212,255,.1);padding:15px;border-radius:10px;margin-bottom:20px;border:1px solid rgba(0,212,255,.2);">
        <h4 style="color:#00D4FF;margin-bottom:15px;font-weight:700;">üèÜ Top Salespeople</h4>
        <div id="top-salespeople-list"></div>
      </div>
      <div style="background:rgba(0,212,255,.1);padding:15px;border-radius:10px;margin-bottom:20px;border:1px solid rgba(0,212,255,.2);">
        <h4 style="color:#00D4FF;margin-bottom:15px;font-weight:700;">üöó Best Selling Cars</h4>
        <div id="best-selling-list"></div>
      </div>
      <button class="btn btn-primary" onclick="calculateAnalytics()" style="margin-bottom:15px;">üîÑ Refresh Analytics</button>
    </div>

    <div style="text-align:center;padding:20px 0 100px 0;color:#00D4FF;font-size:13px;font-weight:700;">Created by WM ‚ù§Ô∏è</div>

    <!-- BOTTOM NAV -->
    <div class="tab-buttons">
      <button class="tab-btn active" onclick="switchTab('upload',event)"><span class="tab-icon">üì§</span><span>Upload</span></button>
      <button class="tab-btn" onclick="switchTab('verify',event)"><span class="tab-icon">üîç</span><span>Verify</span></button>
      <button class="tab-btn" onclick="switchTab('payments',event)"><span class="tab-icon">üí∞</span><span>Pay</span><span class="badge hidden" id="payment-badge">0</span></button>
      <button class="tab-btn" onclick="switchTab('search',event)"><span class="tab-icon">üîç</span><span>Search</span></button>
      <button class="tab-btn" onclick="switchTab('all',event)"><span class="tab-icon">üìã</span><span>All</span></button>
      <button class="tab-btn" onclick="switchTab('profit',event)"><span class="tab-icon">üíµ</span><span>Profit</span></button>
      <button class="tab-btn" onclick="switchTab('analytics',event)"><span class="tab-icon">üìä</span><span>Stats</span></button>
    </div>
  </div>
</div>

<!-- RECEIPT MODAL -->
<div id="modal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeModal()">‚úï Close</button>
    <img id="modal-image" class="modal-image">
    <div style="text-align:center;margin-top:15px;">
      <div style="color:white;font-size:20px;font-weight:700" id="modal-reg"></div>
      <div style="color:white;font-size:14px;margin-top:5px" id="modal-details"></div>
      <div id="modal-installments" style="margin-top:15px;"></div>
      <div style="margin-top:15px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="downloadReceipt()" style="width:auto;padding:10px 20px;background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);">üíæ Download</button>
        <button class="btn btn-primary" onclick="editReceipt()" style="width:auto;padding:10px 20px;background:linear-gradient(135deg,#D4AF37 0%,#FFD700 100%);color:#333;">‚úèÔ∏è Edit</button>
        <button class="btn btn-primary" onclick="openDriveLink()" style="width:auto;padding:10px 20px;">üìÅ Drive</button>
        <button class="delete-btn" onclick="deleteReceipt()">üóëÔ∏è Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div id="edit-modal" class="modal">
  <div class="modal-content" style="max-width:600px;">
    <button class="close-modal" onclick="closeEditModal()">‚úï Close</button>
    <div style="background:white;padding:30px;border-radius:16px;margin-top:50px;max-height:80vh;overflow-y:auto;">
      <h3 style="color:#00D4FF;margin-bottom:20px;font-weight:800;text-align:center;">‚úèÔ∏è Edit Receipt</h3>
      <div class="success-msg" id="edit-success"></div>
      <div class="error-msg" id="edit-error"></div>
      <div class="form-group"><label>Car Name/Model</label><input type="text" id="edit-car-name"></div>
      <div class="form-group"><label>Registration Number</label><input type="text" id="edit-reg-number" style="text-transform:uppercase"></div>
      <div class="form-group"><label>Customer Name</label><input type="text" id="edit-customer-name"></div>
      <div class="form-group"><label>Customer Phone</label><input type="text" id="edit-customer-phone"></div>
      <div class="form-group"><label>Selling Date</label><input type="date" id="edit-selling-date"></div>
      <div class="form-group"><label>Selling Price (PKR)</label><input type="number" id="edit-selling-price" min="0" step="1000"></div>
      <div class="form-group"><label>Purchase Cost (PKR)</label><input type="number" id="edit-purchase-cost" min="0" step="1000"></div>
      <div class="form-group"><label>Payment Type</label><input type="text" id="edit-payment-type" readonly style="background:#f0f0f0;"></div>
      <div class="form-group"><label>Down Payment (PKR)</label><input type="number" id="edit-down-payment" min="0" step="1000"></div>
      <div class="form-group"><label>Sold By</label><select id="edit-sold-by"><option value="">Select Employee</option></select></div>
      <button class="btn btn-primary" onclick="saveEditedReceipt()">üíæ Save All Changes</button>
      <button class="btn" onclick="closeEditModal()" style="background:#6c757d;color:white;margin-top:10px;">Cancel</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// CONFIGURATION
// ============================================================
const CONFIG = {
  SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzvc54Dd15hxZRpPgerPuEn7wmYaD4ZFBYypC9PuB4PrfMEllpXMKLe4PEW10WdRKrs/exec',
  PASSWORD: 'showroom2025',
  LICENSE_KEY: '',
  USER_EMAIL: ''
};

let currentLang = 'en';
let employeesList = [];
let currentViewingReceipt = null;
let allReceiptsCache = [];
let allInstallmentsCache = [];
let allExpensesCache = [];
let expenseFieldCount = 0;
let usageData = {};

// ============================================================
// LICENSE ACTIVATION
// ============================================================
function activateLicense() {
  const licenseKey = document.getElementById('license-key').value.trim().toUpperCase();
  const userEmail = document.getElementById('user-email').value.trim().toLowerCase();
  const errorMsg = document.getElementById('license-error');
  
  if (!licenseKey || !userEmail) {
    errorMsg.textContent = '‚ùå Please enter both license key and email';
    errorMsg.style.display = 'block';
    return;
  }
  
  if (!userEmail.includes('@')) {
    errorMsg.textContent = '‚ùå Please enter a valid email address';
    errorMsg.style.display = 'block';
    return;
  }
  
  // Save credentials
  CONFIG.LICENSE_KEY = licenseKey;
  CONFIG.USER_EMAIL = userEmail;
  localStorage.setItem('licenseKey', licenseKey);
  localStorage.setItem('userEmail', userEmail);
  
  // Validate with server
  validateLicenseWithServer(licenseKey, userEmail);
}

async function validateLicenseWithServer(licenseKey, userEmail) {
  try {
    const response = await post({
      action: 'getAll',
      licenseKey: licenseKey,
      userEmail: userEmail
    });
    
    if (response.success) {
      // License valid, show login screen
      document.getElementById('license-screen').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
    } else {
      const errorMsg = document.getElementById('license-error');
      errorMsg.textContent = '‚ùå ' + (response.error || 'Invalid license or email');
      errorMsg.style.display = 'block';
    }
  } catch(error) {
    const errorMsg = document.getElementById('license-error');
    errorMsg.textContent = '‚ùå Connection error. Please check your internet.';
    errorMsg.style.display = 'block';
  }
}

function resetLicense() {
  localStorage.removeItem('licenseKey');
  localStorage.removeItem('userEmail');
  localStorage.removeItem('loggedIn');
  CONFIG.LICENSE_KEY = '';
  CONFIG.USER_EMAIL = '';
  document.getElementById('license-screen').classList.remove('hidden');
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('main-app').classList.add('hidden');
}

// ============================================================
// LOGIN
// ============================================================
function login() {
  const pw = document.getElementById('login-password').value;
  const err = document.getElementById('login-error');
  
  if (pw === CONFIG.PASSWORD) {
    sessionStorage.setItem('loggedIn', 'true');
    showMainApp();
  } else {
    err.textContent = '‚ùå Incorrect password';
    err.style.display = 'block';
  }
}

function logout() {
  sessionStorage.removeItem('loggedIn');
  document.getElementById('login-screen').classList.remove('hidden');
  document.getElementById('main-app').classList.add('hidden');
}

function showMainApp() {
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('main-app').classList.remove('hidden');
  loadAllData();
}

// ============================================================
// API CALLS
// ============================================================
async function post(data) {
  const response = await fetch(CONFIG.SCRIPT_URL, {
    method: 'POST',
    body: JSON.stringify({
      ...data,
      licenseKey: CONFIG.LICENSE_KEY,
      userEmail: CONFIG.USER_EMAIL
    })
  });
  
  const result = await response.json();
  
  // Handle errors
  if (!result.success) {
    if (result.action === 'INVALID_LICENSE' || result.action === 'NO_ACCESS' || 
        result.action === 'ACCOUNT_SUSPENDED' || result.action === 'LICENSE_EXPIRED') {
      alert(result.error + '\n\nYou will be logged out.');
      resetLicense();
    } else if (result.action === 'UPGRADE_REQUIRED') {
      showUpgradeAlert(result.error);
    } else if (result.action === 'PAYMENT_REQUIRED') {
      showPaymentAlert(result.error);
    }
  }
  
  return result;
}

function showUpgradeAlert(message) {
  const alert = document.getElementById('usage-alert');
  const text = document.getElementById('usage-alert-text');
  text.innerHTML = message + '<br><br><strong>Contact support to upgrade your plan.</strong><br>WhatsApp: +92-XXX-XXXXXXX';
  alert.style.display = 'block';
}

function showPaymentAlert(message) {
  alert(message);
}

// ============================================================
// DATA LOADING
// ============================================================
async function loadAllData() {
  try {
    const result = await post({ action: 'getAll' });
    
    if (result.success) {
      allReceiptsCache = result.receipts || [];
      allInstallmentsCache = result.installments || [];
      allExpensesCache = result.expenses || [];
      employeesList = (result.employees || []).map(e => e.employeeName);
      usageData = result.usage || {};
      
      // Merge expenses into receipts
      allReceiptsCache.forEach(r => {
        const exps = allExpensesCache.filter(e => e.receiptId === r.receiptId);
        if (exps.length > 0) {
          r.expenses = exps.map(e => ({
            type: e.expenseType,
            description: e.description,
            amount: parseFloat(e.amount) || 0
          }));
        } else if (!r.expenses) {
          r.expenses = [];
        }
      });
      
      // Update UI
      updateCustomerInfo();
      updateUsageDisplay();
      loadEmployeesIntoDropdowns();
      checkOverduePayments();
    }
  } catch(error) {
    console.error('Error loading data:', error);
  }
}

function updateCustomerInfo() {
  if (usageData.plan) {
    document.getElementById('customer-info').textContent = 
      `${usageData.plan} Plan | Expires: ${usageData.expiryDate}`;
  }
}

function updateUsageDisplay() {
  const used = usageData.receiptsThisMonth || 0;
  const max = usageData.maxReceipts || 0;
  const percent = max > 0 ? Math.min((used / max) * 100, 100) : 0;
  const charges = usageData.currentCharges || 0;
  
  document.getElementById('usage-receipts').textContent = `${used}/${max}`;
  document.getElementById('usage-bar').style.width = percent + '%';
  
  let detail = `Plan: ${usageData.plan || 'Loading...'}`;
  if (charges > 0) {
    detail += ` | Extra charges this month: ‚Ç®${charges.toLocaleString()}`;
  }
  document.getElementById('usage-detail').textContent = detail;
}

// ============================================================
// USER MANAGEMENT
// ============================================================
function manageUsers() {
  const action = prompt('üë§ User Management\n\n1 - View all users\n2 - Add new user\n3 - Remove user\n\nEnter choice:');
  
  if (action === '1') {
    listUsers();
  } else if (action === '2') {
    addUser();
  } else if (action === '3') {
    removeUser();
  }
}

async function listUsers() {
  const result = await post({ action: 'listUsers' });
  
  if (result.success) {
    if (result.users.length === 0) {
      alert('No users found.');
      return;
    }
    
    let msg = 'Users with access:\n\n';
    result.users.forEach(u => {
      msg += `${u.role}: ${u.email}\n`;
      msg += `  Added: ${new Date(u.addedDate).toLocaleDateString()}\n`;
      msg += `  Last login: ${new Date(u.lastLogin).toLocaleDateString()}\n\n`;
    });
    alert(msg);
  }
}

async function addUser() {
  const email = prompt('Enter user email to add:');
  if (!email || !email.includes('@')) {
    alert('Invalid email');
    return;
  }
  
  const role = prompt('Role? (OWNER/USER)').toUpperCase();
  if (role !== 'OWNER' && role !== 'USER') {
    alert('Invalid role. Must be OWNER or USER');
    return;
  }
  
  const result = await post({
    action: 'addUser',
    newUserEmail: email.toLowerCase(),
    role: role
  });
  
  if (result.success) {
    alert('‚úÖ User added! They can now login with:\n\nLicense Key: ' + CONFIG.LICENSE_KEY + '\nEmail: ' + email);
  } else {
    alert('‚ùå ' + result.error);
  }
}

async function removeUser() {
  const email = prompt('Enter email to remove:');
  if (!email) return;
  
  if (!confirm(`Remove ${email}?`)) return;
  
  const result = await post({
    action: 'removeUser',
    removeUserEmail: email.toLowerCase()
  });
  
  if (result.success) {
    alert('‚úÖ User removed');
  } else {
    alert('‚ùå ' + result.error);
  }
}

// ============================================================
// EMPLOYEES
// ============================================================
function manageEmployees() {
  const a = prompt('üë• Manage Employees\n\n1 - View All\n2 - Add New\n3 - Remove\n\nEnter choice:');
  if (a === '1') { alert(employeesList.length ? 'Employees:\n' + employeesList.join('\n') : 'No employees yet.'); }
  else if (a === '2') {
    const n = prompt('Enter employee name:');
    if (n && n.trim() && !employeesList.includes(n.trim())) {
      employeesList.push(n.trim());
      employeesList.sort();
      loadEmployeesIntoDropdowns();
      alert('‚úÖ Added: ' + n.trim());
      // Note: In real implementation, save to backend
    }
  } else if (a === '3') {
    const r = prompt('Remove:\n' + employeesList.join('\n') + '\n\nEnter name:');
    const i = employeesList.indexOf(r && r.trim());
    if (i > -1) { employeesList.splice(i,1); loadEmployeesIntoDropdowns(); alert('‚úÖ Removed'); }
  }
}

function loadEmployeesIntoDropdowns() {
  ['sold-by','search-employee','edit-sold-by'].forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    const first = sel.options[0].textContent;
    sel.innerHTML = `<option value="">${first}</option>`;
    employeesList.forEach(e => { const o = document.createElement('option'); o.value = o.textContent = e; sel.appendChild(o); });
  });
}

// ============================================================
// EXPENSES
// ============================================================
function addExpenseField() {
  expenseFieldCount++;
  const c = document.getElementById('expenses-container');
  const d = document.createElement('div');
  d.className = 'installment-item';
  d.id = 'expense-' + expenseFieldCount;
  d.style.marginBottom = '10px';
  d.innerHTML = `<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <select id="expense-type-${expenseFieldCount}" style="flex:1;min-width:90px;">
      <option value="Repair">Repair</option><option value="Maintenance">Maintenance</option>
      <option value="Modification">Modification</option><option value="Other">Other</option>
    </select>
    <input type="text" id="expense-desc-${expenseFieldCount}" placeholder="Description" style="flex:2;min-width:100px;">
    <input type="number" id="expense-amount-${expenseFieldCount}" placeholder="Amount" min="0" step="1000" style="flex:1;min-width:80px;">
    <button type="button" onclick="removeExpenseField(${expenseFieldCount})" class="delete-btn" style="padding:8px 12px;">‚úï</button>
  </div>`;
  c.appendChild(d);
}

function removeExpenseField(id) { const el = document.getElementById('expense-'+id); if(el) el.remove(); }

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  // Check if license exists
  const savedLicense = localStorage.getItem('licenseKey');
  const savedEmail = localStorage.getItem('userEmail');
  
  if (savedLicense && savedEmail) {
    CONFIG.LICENSE_KEY = savedLicense;
    CONFIG.USER_EMAIL = savedEmail;
    
    // Check if logged in
    if (sessionStorage.getItem('loggedIn') === 'true') {
      showMainApp();
    } else {
      document.getElementById('license-screen').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
    }
  } else {
    // Show license screen
    document.getElementById('license-screen').classList.remove('hidden');
  }
  
  document.getElementById('receipt-photo').addEventListener('change', e => {
    const f = e.target.files[0];
    if (f) { const r = new FileReader(); r.onload = ev => { const p = document.getElementById('preview'); p.src = ev.target.result; p.style.display = 'block'; }; r.readAsDataURL(f); }
  });
  
  document.getElementById('login-password').addEventListener('keyup', e => { if(e.key==='Enter') login(); });
  document.getElementById('selling-date').value = new Date().toISOString().split('T')[0];
});

// ============================================================
// TAB SWITCHING
// ============================================================
function switchTab(tab, ev) {
  if (ev) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); ev.target.closest('.tab-btn').classList.add('active'); }
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tab+'-tab').classList.add('active');
  
  if (tab==='all') loadAllReceipts();
  else if (tab==='analytics') calculateAnalytics();
  else if (tab==='payments') loadPayments();
  else if (tab==='profit') calculateProfit();
}

function switchTabDirect(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tab+'-tab').classList.add('active');
  if (tab==='payments') loadPayments();
}

// ============================================================
// INSTALLMENTS
// ============================================================
function toggleInstallmentSection() {
  const pt = document.querySelector('input[name="payment-type"]:checked').value;
  document.getElementById('installment-section').style.display = pt==='INSTALLMENT' ? 'block' : 'none';
  if (pt==='INSTALLMENT') generateInstallmentFields();
}

function generateInstallmentFields() {
  const cnt = parseInt(document.getElementById('installment-count').value);
  let h = '<h4 style="color:#00D4FF;margin:15px 0 10px 0;font-weight:700;">Installment Details:</h4>';
  for (let i=1; i<=cnt; i++) {
    h += `<div class="installment-item"><strong>Installment ${i}</strong>
      <div class="form-group"><label>Due Date</label><input type="date" id="inst-date-${i}"></div>
      <div class="form-group"><label>Amount (PKR)</label><input type="number" id="inst-amount-${i}" placeholder="Amount" min="0" step="1000"></div></div>`;
  }
  document.getElementById('installment-fields').innerHTML = h;
}

// ============================================================
// VEHICLE VERIFICATION
// ============================================================
async function verifyVehicle() {
  const reg = document.getElementById('verify-reg').value.trim().toUpperCase();
  const results = document.getElementById('verify-results');
  
  if (!reg) { alert('Please enter registration number'); return; }
  
  results.innerHTML = '<div class="loading">Verifying...</div>';
  
  const url = `https://excise.gos.pk/vehicle/vehicle_search?registration_no=${encodeURIComponent(reg)}`;
  
  results.innerHTML = `<div style="background:rgba(23,162,184,.1);border-left:4px solid #17a2b8;padding:15px;border-radius:10px;">
    <strong style="color:#17a2b8;">Vehicle Verification Portal</strong>
    <p style="margin-top:10px;color:#666;">Registration: <strong>${reg}</strong></p>
    <p style="margin-top:10px;color:#666;">Verify at official portal:</p>
    <a href="${url}" target="_blank" style="display:inline-block;margin-top:10px;padding:10px 20px;background:#17a2b8;color:white;text-decoration:none;border-radius:8px;font-weight:700;">
      üîç Open Sindh Excise Portal
    </a>
    <p style="margin-top:10px;font-size:12px;color:#999;">Note: Opens in new tab - official government website</p>
  </div>`;
}

async function verifyVehicleQuick() {
  const reg = document.getElementById('reg-number').value.trim().toUpperCase();
  const results = document.getElementById('quick-verify-result');
  
  if (!reg) { alert('Please enter registration number first'); return; }
  
  const url = `https://excise.gos.pk/vehicle/vehicle_search?registration_no=${encodeURIComponent(reg)}`;
  
  results.style.display = 'block';
  results.innerHTML = `<strong style="color:#17a2b8;">Quick Verify</strong>
    <p style="margin-top:5px;font-size:12px;">Reg: <strong>${reg}</strong></p>
    <a href="${url}" target="_blank" style="display:inline-block;margin-top:8px;padding:6px 12px;background:#17a2b8;color:white;text-decoration:none;border-radius:6px;font-size:12px;font-weight:700;">
      üîç Verify Now
    </a>`;
}

// ============================================================
// UPLOAD RECEIPT
// ============================================================
async function uploadReceipt() {
  const v = {
    carName: document.getElementById('car-name').value.trim(),
    regNumber: document.getElementById('reg-number').value.trim().toUpperCase(),
    customerName: document.getElementById('customer-name').value.trim(),
    customerPhone: document.getElementById('customer-phone').value.trim(),
    sellingDate: document.getElementById('selling-date').value,
    sellingPrice: document.getElementById('selling-price').value.trim(),
    purchaseCost: document.getElementById('purchase-cost').value.trim(),
    soldBy: document.getElementById('sold-by').value
  };
  
  const expenses = [];
  for (let i=1; i<=expenseFieldCount; i++) {
    const tEl=document.getElementById(`expense-type-${i}`), dEl=document.getElementById(`expense-desc-${i}`), aEl=document.getElementById(`expense-amount-${i}`);
    if (tEl&&dEl&&aEl) { const amt=parseFloat(aEl.value)||0; if(amt>0) expenses.push({type:tEl.value, description:dEl.value.trim()||'No description', amount:amt}); }
  }
  
  const paymentType = document.querySelector('input[name="payment-type"]:checked').value;
  const photoFile = document.getElementById('receipt-photo').files[0];
  const sMsg = document.getElementById('upload-success'), eMsg = document.getElementById('upload-error');
  
  sMsg.style.display='none'; eMsg.style.display='none';
  
  if (!v.carName||!v.regNumber||!v.customerName||!v.customerPhone||!v.sellingDate||!v.sellingPrice||parseFloat(v.sellingPrice)<=0||!v.purchaseCost||parseFloat(v.purchaseCost)<=0||!v.soldBy||!photoFile) {
    eMsg.textContent='Please fill all required fields'; eMsg.style.display='block'; return;
  }
  
  let downPayment=0, installments=[];
  if (paymentType==='INSTALLMENT') {
    downPayment = parseFloat(document.getElementById('down-payment').value)||0;
    if (downPayment<=0) { eMsg.textContent='Please enter down payment'; eMsg.style.display='block'; return; }
    const cnt = parseInt(document.getElementById('installment-count').value);
    for (let i=1; i<=cnt; i++) {
      const dt=document.getElementById(`inst-date-${i}`).value, am=parseFloat(document.getElementById(`inst-amount-${i}`).value)||0;
      if (!dt||am<=0) { eMsg.textContent=`Fill installment ${i} details`; eMsg.style.display='block'; return; }
      installments.push({dueDate:dt, amount:am});
    }
  }
  
  if (photoFile.size>10*1024*1024) { eMsg.textContent='Image too large (max 10MB)'; eMsg.style.display='block'; return; }
  
  const btn=event.target, origTxt=btn.innerHTML; btn.innerHTML='‚è≥ Uploading...'; btn.disabled=true;
  
  try {
    const imageData = await new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.onerror=()=>rej(new Error('Failed to read image'));r.readAsDataURL(photoFile);});
    const receiptId = v.regNumber+'_'+v.sellingDate+'_'+Date.now();
    
    const result = await post({
      action:'upload',
      receiptId,
      ...v,
      sellingPrice:parseFloat(v.sellingPrice),
      purchaseCost:parseFloat(v.purchaseCost),
      expenses,
      paymentType,
      downPayment,
      installments,
      imageData,
      fileName:receiptId+'.'+photoFile.name.split('.').pop(),
      mimeType:photoFile.type,
      timestamp:new Date().toISOString()
    });
    
    if (result.success) {
      sMsg.textContent=`‚úÖ Receipt saved for ${v.carName} (${v.regNumber})`;
      if (result.billing && result.billing.charge > 0) {
        sMsg.textContent += `\n${result.billing.message}`;
      }
      sMsg.style.display='block';
      
      ['car-name','reg-number','customer-name','customer-phone','selling-price','purchase-cost','sold-by'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('expenses-container').innerHTML=''; expenseFieldCount=0;
      document.getElementById('receipt-photo').value=''; document.getElementById('preview').style.display='none';
      document.querySelector('input[name="payment-type"][value="CASH"]').checked=true; toggleInstallmentSection();
      
      await loadAllData();
      window.scrollTo(0,0);
    } else throw new Error(result.error||'Upload failed');
  } catch(err) { eMsg.textContent='‚ùå '+err.message; eMsg.style.display='block'; }
  finally { btn.innerHTML=origTxt; btn.disabled=false; }
}

// ============================================================
// LOAD RECEIPTS
// ============================================================
async function loadAllReceipts() {
  const div = document.getElementById('all-receipts');
  div.innerHTML='<div class="loading">Loading...</div>';
  
  try {
    await loadAllData();
    document.getElementById('total-receipts').textContent = allReceiptsCache.length;
    
    if (allReceiptsCache.length > 0) {
      allReceiptsCache.sort((a,b)=>new Date(b.sellingDate)-new Date(a.sellingDate));
      div.innerHTML = allReceiptsCache.map(r => receiptCardHTML(r)).join('');
    } else {
      div.innerHTML='<div class="no-results">No receipts yet</div>';
    }
  } catch(err) { div.innerHTML='<div class="no-results">Error loading receipts</div>'; console.error(err); }
}

function receiptCardHTML(r) {
  const dt = new Date(r.sellingDate).toLocaleDateString();
  const pr = '‚Ç®'+parseFloat(r.sellingPrice).toLocaleString();
  let sc='', sb='';
  
  if (r.paymentType==='CASH') {
    sb='<span class="payment-badge cash">üíµ Paid in Full</span>';
  } else {
    const ri=allInstallmentsCache.filter(i=>i.receiptId===r.receiptId);
    const pend=ri.filter(i=>i.status==='PENDING'), over=pend.filter(i=>new Date(i.dueDate)<new Date());
    if(over.length>0){sc='overdue-payment';sb=`<span class="payment-badge pending">‚ö†Ô∏è ${over.length} Overdue</span>`;}
    else if(pend.length>0){sc='pending-payment';sb=`<span class="payment-badge installment">üìÖ ${pend.length} Pending</span>`;}
    else sb='<span class="payment-badge cash">‚úÖ Completed</span>';
  }
  
  return `<div class="receipt-item ${sc}" onclick='viewReceiptByData(${JSON.stringify(r).replace(/'/g,"&#39;")})'>
    <div class="receipt-reg">${r.carName||'N/A'}</div>
    <div class="receipt-date">Reg: ${r.regNumber}</div>
    <div class="receipt-date">Customer: ${r.customerName||'N/A'}</div>
    <div class="receipt-date">Date: ${dt} ¬∑ Price: ${pr}</div>
    <div class="receipt-date">Sold by: ${r.soldBy||'N/A'}</div>
    ${sb}</div>`;
}

// ============================================================
// PAYMENTS
// ============================================================
async function loadPayments() {
  try {
    await loadAllData();
    displayPaymentSummary();
  } catch(err) { console.error(err); }
}

function displayPaymentSummary() {
  const ir = allReceiptsCache.filter(r=>r.paymentType==='INSTALLMENT');
  let tp=0, tr=0, pl='';
  
  ir.forEach(r=>{
    const ri=allInstallmentsCache.filter(i=>i.receiptId===r.receiptId);
    const pend=ri.filter(i=>i.status==='PENDING'), paid=ri.filter(i=>i.status==='PAID');
    tp+=pend.reduce((s,i)=>s+parseFloat(i.amount),0);
    tr+=parseFloat(r.downPayment||0)+paid.reduce((s,i)=>s+parseFloat(i.amount),0);
    if(pend.length>0){
      const ov=pend.filter(i=>new Date(i.dueDate)<new Date());
      pl+=`<div class="receipt-item ${ov.length>0?'overdue-payment':'pending-payment'}" onclick='viewReceiptByData(${JSON.stringify(r).replace(/'/g,"&#39;")})'><div class="receipt-reg">${r.carName} (${r.regNumber})</div><div class="receipt-date">Customer: ${r.customerName}</div><div class="receipt-date">Pending: ‚Ç®${pend.reduce((s,i)=>s+parseFloat(i.amount),0).toLocaleString()}</div>${ov.length>0?`<span class="payment-badge pending">‚ö†Ô∏è ${ov.length} Overdue</span>`:`<span class="payment-badge installment">üìÖ ${pend.length} Pending</span>`}</div>`;
    }
  });
  
  document.getElementById('total-pending').textContent='‚Ç®'+tp.toLocaleString();
  document.getElementById('total-received').textContent='‚Ç®'+tr.toLocaleString();
  document.getElementById('payments-list').innerHTML=pl||'<div class="no-results">No pending payments</div>';
}

function checkOverduePayments() {
  const today=new Date();
  const ov=allInstallmentsCache.filter(i=>i.status==='PENDING'&&new Date(i.dueDate)<today);
  const up=allInstallmentsCache.filter(i=>{const d=new Date(i.dueDate),df=Math.ceil((d-today)/86400000);return i.status==='PENDING'&&df>=0&&df<=7;});
  
  if(ov.length>0){
    document.getElementById('overdue-badge').classList.remove('hidden');
    document.getElementById('overdue-count').textContent=ov.length;
    document.getElementById('payment-badge').classList.remove('hidden');
    document.getElementById('payment-badge').textContent=ov.length;
  } else {
    document.getElementById('overdue-badge').classList.add('hidden');
    document.getElementById('payment-badge').classList.add('hidden');
  }
  
  if(ov.length>0){
    document.getElementById('overdue-list').innerHTML=ov.map(i=>{
      const r=allReceiptsCache.find(x=>x.receiptId===i.receiptId);
      return r?`<div>‚Ä¢ ${r.carName} (${r.regNumber}) - ‚Ç®${parseFloat(i.amount).toLocaleString()} - ${Math.ceil((today-new Date(i.dueDate))/86400000)} days overdue</div>`:''
    }).join('');
    document.getElementById('overdue-alert').style.display='block';
  } else document.getElementById('overdue-alert').style.display='none';
  
  if(up.length>0){
    document.getElementById('upcoming-list').innerHTML=up.map(i=>{
      const r=allReceiptsCache.find(x=>x.receiptId===i.receiptId);
      return r?`<div>‚Ä¢ ${r.carName} (${r.regNumber}) - ‚Ç®${parseFloat(i.amount).toLocaleString()} - Due in ${Math.ceil((new Date(i.dueDate)-today)/86400000)} days</div>`:''
    }).join('');
    document.getElementById('upcoming-alert').style.display='block';
  } else document.getElementById('upcoming-alert').style.display='none';
}

// ============================================================
// VIEW RECEIPT
// ============================================================
async function viewReceiptByData(receipt) {
  const mi=document.getElementById('modal-image');
  mi.src=`https://drive.google.com/thumbnail?id=${receipt.driveFileId}&sz=w1000`;
  mi.onerror=function(){this.src=`https://drive.google.com/uc?export=view&id=${receipt.driveFileId}`;};
  
  document.getElementById('modal-reg').textContent=`${receipt.carName} (${receipt.regNumber})`;
  const dt=new Date(receipt.sellingDate).toLocaleDateString();
  document.getElementById('modal-details').innerHTML=`Customer: ${receipt.customerName}<br>Phone: ${receipt.customerPhone}<br>Date: ${dt}<br>Price: ‚Ç®${parseFloat(receipt.sellingPrice).toLocaleString()}<br>Sold by: ${receipt.soldBy}<br>Payment: ${receipt.paymentType}`;
  
  const mi2=document.getElementById('modal-installments');
  if(receipt.paymentType==='INSTALLMENT'){
    const ri=allInstallmentsCache.filter(i=>i.receiptId===receipt.receiptId);
    let h='<div style="background:rgba(255,255,255,.1);padding:15px;border-radius:10px;margin-top:15px;">';
    h+=`<div style="color:white;font-weight:700;margin-bottom:10px;">Down Payment: ‚Ç®${parseFloat(receipt.downPayment).toLocaleString()}</div>`;
    ri.forEach(i=>{
      const ip=i.status==='PAID',io=!ip&&new Date(i.dueDate)<new Date();
      const sc=ip?'#28a745':io?'#dc3545':'#D4AF37', st=ip?'‚úÖ Paid':io?'‚ö†Ô∏è Overdue':'üìÖ Pending';
      h+=`<div style="background:rgba(255,255,255,.2);padding:10px;border-radius:8px;margin-bottom:8px;border-left:4px solid ${sc};">
        <div style="color:white;">Installment ${i.installmentNumber}: ‚Ç®${parseFloat(i.amount).toLocaleString()}</div>
        <div style="color:white;font-size:12px;">Due: ${new Date(i.dueDate).toLocaleDateString()}</div>
        <div style="color:${sc};font-weight:700;font-size:12px;">${st}</div>
        ${!ip?`<button class="btn btn-success btn-small" style="margin-top:8px;" onclick="markInstallmentPaid('${i.installmentId}',event)">Mark as Paid</button>`:''}
      </div>`;
    });
    h+='</div>'; mi2.innerHTML=h;
  } else mi2.innerHTML='';
  
  document.getElementById('modal').classList.add('active');
  currentViewingReceipt=receipt;
}

async function markInstallmentPaid(iid,ev) {
  ev.stopPropagation();
  if(!confirm('Mark as paid?')) return;
  try {
    const r=await post({action:'markInstallmentPaid', installmentId:iid});
    if(r.success){alert('‚úÖ Marked as paid');await loadAllData();closeModal();}
    else throw new Error(r.error);
  } catch(e){alert('‚ùå Error: '+e.message);}
}

function closeModal(){document.getElementById('modal').classList.remove('active');currentViewingReceipt=null;}
function openDriveLink(){if(currentViewingReceipt&&currentViewingReceipt.driveLink)window.open(currentViewingReceipt.driveLink,'_blank');}

async function downloadReceipt() {
  if(!currentViewingReceipt) return;
  const link=document.createElement('a');
  link.href=`https://drive.google.com/uc?export=download&id=${currentViewingReceipt.driveFileId}`;
  link.download=`${currentViewingReceipt.regNumber}_${currentViewingReceipt.carName}.jpg`;
  link.target='_blank'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
  alert('‚úÖ Download started!');
}

// ============================================================
// EDIT RECEIPT
// ============================================================
function editReceipt() {
  if(!currentViewingReceipt) return;
  closeModal();
  const r=currentViewingReceipt;
  
  document.getElementById('edit-car-name').value=r.carName||'';
  document.getElementById('edit-reg-number').value=r.regNumber||'';
  document.getElementById('edit-customer-name').value=r.customerName||'';
  document.getElementById('edit-customer-phone').value=r.customerPhone||'';
  document.getElementById('edit-selling-date').value=r.sellingDate||'';
  document.getElementById('edit-selling-price').value=r.sellingPrice||'';
  document.getElementById('edit-purchase-cost').value=r.purchaseCost||'';
  document.getElementById('edit-payment-type').value=r.paymentType||'CASH';
  document.getElementById('edit-down-payment').value=r.downPayment||0;
  
  const sel=document.getElementById('edit-sold-by');
  sel.innerHTML='<option value="">Select Employee</option>';
  employeesList.forEach(e=>{const o=document.createElement('option');o.value=o.textContent=e;if(e===r.soldBy)o.selected=true;sel.appendChild(o);});
  
  document.getElementById('edit-modal').classList.add('active');
  ['edit-success','edit-error'].forEach(id=>document.getElementById(id).style.display='none');
}

function closeEditModal(){document.getElementById('edit-modal').classList.remove('active');}

async function saveEditedReceipt() {
  const vals={
    carName:document.getElementById('edit-car-name').value.trim(),
    regNumber:document.getElementById('edit-reg-number').value.trim().toUpperCase(),
    customerName:document.getElementById('edit-customer-name').value.trim(),
    customerPhone:document.getElementById('edit-customer-phone').value.trim(),
    sellingDate:document.getElementById('edit-selling-date').value,
    sellingPrice:document.getElementById('edit-selling-price').value.trim(),
    purchaseCost:document.getElementById('edit-purchase-cost').value.trim(),
    paymentType:document.getElementById('edit-payment-type').value,
    downPayment:document.getElementById('edit-down-payment').value.trim(),
    soldBy:document.getElementById('edit-sold-by').value
  };
  
  const err=document.getElementById('edit-error'), suc=document.getElementById('edit-success');
  err.style.display='none'; suc.style.display='none';
  
  if(Object.values(vals).some(v=>v==='')){err.textContent='Please fill all fields';err.style.display='block';return;}
  
  const btn=event.target, ot=btn.innerHTML; btn.innerHTML='‚è≥ Saving...'; btn.disabled=true;
  
  try {
    const r=await post({
      action:'updateReceipt',
      receiptId:currentViewingReceipt.receiptId,
      ...vals,
      sellingPrice:parseFloat(vals.sellingPrice),
      purchaseCost:parseFloat(vals.purchaseCost),
      downPayment:parseFloat(vals.downPayment)||0
    });
    
    if(r.success){
      suc.textContent='‚úÖ All changes saved!';
      suc.style.display='block';
      await loadAllData();
      setTimeout(closeEditModal,1500);
    } else throw new Error(r.error||'Update failed');
  } catch(e){err.textContent='‚ùå '+e.message;err.style.display='block';}
  finally{btn.innerHTML=ot;btn.disabled=false;}
}

// ============================================================
// DELETE
// ============================================================
async function deleteReceipt() {
  if(!currentViewingReceipt||!confirm('Delete this receipt?')) return;
  try {
    const r=await post({action:'delete', receiptId:currentViewingReceipt.receiptId, driveFileId:currentViewingReceipt.driveFileId});
    if(r.success){closeModal();await loadAllData();alert('‚úÖ Deleted');}
    else throw new Error(r.error);
  } catch(e){alert('‚ùå Error: '+e.message);}
}

// ============================================================
// SEARCH
// ============================================================
async function performSearch() {
  const si=document.getElementById('search-input').value.trim().toUpperCase();
  const se=document.getElementById('search-employee').value;
  const rd=document.getElementById('search-results');
  
  rd.innerHTML='<div class="loading">Searching...</div>';
  
  if(allReceiptsCache.length===0) await loadAllData();
  
  let f=allReceiptsCache;
  if(si) f=f.filter(r=>r.regNumber.includes(si)||(r.carName||'').toUpperCase().includes(si)||(r.customerName||'').toUpperCase().includes(si));
  if(se) f=f.filter(r=>r.soldBy===se);
  
  rd.innerHTML = f.length ? f.map(r=>receiptCardHTML(r)).join('') : '<div class="no-results">‚ùå Not found</div>';
}

// ============================================================
// PROFIT
// ============================================================
function getExpensesForReceipt(r) {
  if (r.expenses && r.expenses.length > 0) return r.expenses;
  return allExpensesCache.filter(e => e.receiptId === r.receiptId)
    .map(e => ({ type: e.expenseType||e.type||'Other', description: e.description||'', amount: parseFloat(e.amount)||0 }));
}

async function calculateProfit() {
  if(allReceiptsCache.length===0) await loadAllData();
  
  let tr=0, tp=0, te=0;
  allReceiptsCache.forEach(r=>{
    tr+=parseFloat(r.sellingPrice)||0;
    tp+=parseFloat(r.purchaseCost)||0;
    te+=getExpensesForReceipt(r).reduce((s,e)=>s+(parseFloat(e.amount)||0),0);
  });
  
  const np=tr-tp-te, pm=tr>0?((np/tr)*100):0;
  
  document.getElementById('profit-revenue').textContent='‚Ç®'+tr.toLocaleString();
  document.getElementById('profit-purchase').textContent='‚Ç®'+tp.toLocaleString();
  document.getElementById('profit-expenses').textContent='‚Ç®'+te.toLocaleString();
  document.getElementById('profit-net').textContent='‚Ç®'+np.toLocaleString();
  document.getElementById('profit-margin').textContent=pm.toFixed(1)+'%';
  
  showProfitBreakdown();
}

function showProfitBreakdown() {
  const c=document.getElementById('profit-breakdown');
  if(!allReceiptsCache.length){c.innerHTML='<div class="no-results">No data</div>';return;}
  
  c.innerHTML=allReceiptsCache.map(r=>{
    const s=parseFloat(r.sellingPrice)||0, p=parseFloat(r.purchaseCost)||0;
    const e=getExpensesForReceipt(r).reduce((sum,x)=>sum+(parseFloat(x.amount)||0),0);
    const pf=s-p-e, mg=s>0?((pf/s)*100):0, col=pf>=0?'#28a745':'#dc3545';
    
    return `<div class="receipt-item" style="border-left:4px solid ${col};">
      <div class="receipt-reg">${r.carName||'N/A'} (${r.regNumber})</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;font-size:12px;">
        <div>Selling: ‚Ç®${s.toLocaleString()}</div><div>Purchase: ‚Ç®${p.toLocaleString()}</div>
        <div>Expenses: ‚Ç®${e.toLocaleString()}</div>
        <div style="font-weight:700;color:${col};">Profit: ‚Ç®${pf.toLocaleString()} (${mg.toFixed(1)}%)</div>
      </div>
      <div class="receipt-date" style="margin-top:8px;">Sold by: ${r.soldBy||'N/A'}</div></div>`;
  }).join('');
}

// ============================================================
// EXPORT
// ============================================================
function exportSalesReport(){
  const d=allReceiptsCache.map(r=>{
    const e=getExpensesForReceipt(r).reduce((s,x)=>s+(parseFloat(x.amount)||0),0);
    const pf=(parseFloat(r.sellingPrice)||0)-(parseFloat(r.purchaseCost)||0)-e;
    return{'Receipt ID':r.receiptId,'Car':r.carName,'Reg':r.regNumber,'Customer':r.customerName,'Phone':r.customerPhone,'Date':r.sellingDate,'Selling':r.sellingPrice,'Purchase':r.purchaseCost||0,'Expenses':e,'Profit':pf,'Payment':r.paymentType,'Sold By':r.soldBy};
  });
  exportToExcel(d,'Sales_Report_'+new Date().toISOString().split('T')[0]);
}

function exportProfitReport(){
  const d=allReceiptsCache.map(r=>{
    const s=parseFloat(r.sellingPrice)||0,p=parseFloat(r.purchaseCost)||0,e=getExpensesForReceipt(r).reduce((s2,x)=>s2+(parseFloat(x.amount)||0),0),pf=s-p-e;
    return{'Car':r.carName,'Reg':r.regNumber,'Date':r.sellingDate,'Selling':s,'Purchase':p,'Expenses':e,'Gross':s-p,'Net Profit':pf,'Margin %':(s>0?((pf/s)*100).toFixed(2):0),'Sold By':r.soldBy};
  });
  exportToExcel(d,'Profit_Report_'+new Date().toISOString().split('T')[0]);
}

function exportPaymentReport(){
  const d=[];
  allReceiptsCache.forEach(r=>{
    if(r.paymentType==='INSTALLMENT'){
      allInstallmentsCache.filter(i=>i.receiptId===r.receiptId).forEach(i=>{
        d.push({'Car':r.carName,'Reg':r.regNumber,'Customer':r.customerName,'Phone':r.customerPhone,'Inst #':i.installmentNumber,'Due':i.dueDate,'Amount':i.amount,'Status':i.status,'Paid':i.paidDate||'N/A'});
      });
    }
  });
  exportToExcel(d,'Payment_Report_'+new Date().toISOString().split('T')[0]);
}

function exportExpenseReport(){
  const d=allExpensesCache.map(e=>{
    const r=allReceiptsCache.find(x=>x.receiptId===e.receiptId);
    return{'Car':r?r.carName:'N/A','Reg':e.receiptId,'Type':e.expenseType||e.type,'Description':e.description,'Amount':e.amount,'Date':e.date};
  });
  exportToExcel(d,'Expense_Report_'+new Date().toISOString().split('T')[0]);
}

function exportToExcel(data,name){
  if(!data||!data.length){alert('‚ùå No data to export');return;}
  const ws=XLSX.utils.json_to_sheet(data),wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Report');
  XLSX.writeFile(wb,name+'.xlsx');
}

// ============================================================
// ANALYTICS
// ============================================================
async function calculateAnalytics() {
  if(allReceiptsCache.length===0) await loadAllData();
  
  const now=new Date();
  const total=allReceiptsCache.length;
  const rev=allReceiptsCache.reduce((s,r)=>s+(parseFloat(r.sellingPrice)||0),0);
  
  document.getElementById('total-cars').textContent=total;
  document.getElementById('total-revenue').textContent='‚Ç®'+rev.toLocaleString();
  
  calculateTopSalespeople();
  calculateBestSellingCars();
}

function calculateTopSalespeople(){
  const es={};
  allReceiptsCache.forEach(r=>{const e=r.soldBy||'Unknown';if(!es[e])es[e]={count:0,revenue:0};es[e].count++;es[e].revenue+=parseFloat(r.sellingPrice)||0;});
  const s=Object.entries(es).sort((a,b)=>b[1].count-a[1].count).slice(0,5);
  const medals=['ü•á','ü•à','ü•â','üèÖ'];
  document.getElementById('top-salespeople-list').innerHTML=s.length?s.map(([n,d],i)=>`<div style="background:white;padding:12px;border-radius:8px;margin-bottom:10px;display:flex;align-items:center;gap:10px;"><span style="font-size:24px;">${medals[Math.min(i,3)]}</span><div><div style="font-weight:700;color:#00D4FF;">${n}</div><div style="font-size:12px;color:#666;">${d.count} cars ¬∑ ‚Ç®${d.revenue.toLocaleString()}</div></div></div>`).join(''):'<div class="no-results">No data</div>';
}

function calculateBestSellingCars(){
  const cc={};
  allReceiptsCache.forEach(r=>{const c=r.carName||'Unknown';if(!cc[c])cc[c]={count:0,revenue:0};cc[c].count++;cc[c].revenue+=parseFloat(r.sellingPrice)||0;});
  const s=Object.entries(cc).sort((a,b)=>b[1].count-a[1].count).slice(0,5);
  const medals=['ü•á','ü•à','ü•â','üèÖ'];
  document.getElementById('best-selling-list').innerHTML=s.length?s.map(([n,d],i)=>`<div style="background:white;padding:12px;border-radius:8px;margin-bottom:10px;display:flex;align-items:center;gap:10px;"><span style="font-size:24px;">${medals[Math.min(i,3)]}</span><div><div style="font-weight:700;color:#00D4FF;">${n}</div><div style="font-size:12px;color:#666;">${d.count} sold ¬∑ ‚Ç®${d.revenue.toLocaleString()}</div></div></div>`).join(''):'<div class="no-results">No data</div>';
}

// ============================================================
// LANGUAGE TOGGLE
// ============================================================
function toggleLanguage() {
  currentLang = currentLang === 'en' ? 'ur' : 'en';
  document.body.classList.toggle('urdu', currentLang === 'ur');
  document.getElementById('lang-text').textContent = currentLang === 'en' ? 'ÿßÿ±ÿØŸà' : 'English';
}

// Close modals on background click
document.getElementById('modal').addEventListener('click',e=>{if(e.target===document.getElementById('modal'))closeModal();});
document.getElementById('edit-modal').addEventListener('click',e=>{if(e.target===document.getElementById('edit-modal'))closeEditModal();});
</script>
</body>
</html>
